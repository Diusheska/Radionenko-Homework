import argparse, pypyodbc, json, collections

def read_sql():
    with open(r'C:\Users\Nadiia_Radionenko\Desktop\user_details_insert.sql', 'r', encoding="utf-8") as script_file:
        script_to_use=" ".join(line.rstrip() for line in script_file)
        return script_to_use

		
def set_up_connection(script_to_run):
    connection = pypyodbc.connect("Driver={SQL Server};"
                                  "Server=EPUALVIW0463;"
                                  "Database=EDW_Test;"
                                  "Trusted_Connection=yes;")
    cursor = connection.cursor()
    cursor_results = cursor.execute(script_to_run)
    return cursor_results


def read_query_results(result_set):
    headers = [element[0] for element in result_set.description]
    data_to_convert = []
    for row in result_set:
        row_to_dict = {k: v for k, v in zip(headers, row) if k != 'password'}
        data_to_convert.append(row_to_dict)
    return data_to_convert
	
	
def convert_to_json(data_to_convert):
    output_json = json.dumps(data_to_convert, sort_keys = True, indent = 4)
    print(output_json)


script_to_use = read_sql()
cursor_results = set_up_connection(script_to_use)
data_to_convert = read_query_results(cursor_results)
convert_to_json(data_to_convert)
