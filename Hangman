import codecs
import re
from collections import Counter
from functools import reduce
import tkinter as tk
from tkinter import filedialog

root = tk.Tk()
root.withdraw()

print("Please select a file to open")

file_path = filedialog.askopenfilename()

# open file, switch to lower and get rid of paragraph breaks
with codecs.open(file_path, encoding='utf-8') as f_obj:
    text = f_obj.read().lower()
    textlist = text.splitlines()

# find max possible length of the word in file
ml = (max(list(map(lambda x: int(len(x)), textlist))))

# ask user for number of letters
print("Hi user! Let's play Hangman game!\n")
while True:
    try:
        wl = int(input("How many letters does your word have?\n"))
    except ValueError:
        print("This is not an integer\n")
        continue
    else:
# check if user input is in within word length
        if 0 < wl <= ml:
            break
        else:
            print("Value is out of range.\n")
            continue

word = ["-"]*wl
# count number of game attempts
attempts = 0

# display how the word looks like
def show_word(w):
    print("\nThis is how the word looks now:")
    print(' '.join(map(str, w)))

# call function to show the word at the beginning
show_word(word)
# list of words filtered based on user's answer
f = list(filter(lambda x: int(len(x)) == wl, textlist))

# count total characters quantity in the filtered list except for letters already known
def filter_length(lst):
    cnt = Counter()
    for w in lst:
        for char in w:
            while char in word:
                cnt[char]+=1
                break
    fl = reduce(lambda x, y: x+y, list(map(lambda x: int(len(x)), lst))) - sum(cnt.values())
    return fl


# show most frequent character for specific list of words
def cnt_char(lst):
    cnt = Counter()
    for w in lst:
        for char in w:
            while char not in (word):
                cnt[char]+=1
                break
    cd = dict(cnt.most_common(1))
    for char, freq in cd.items():
        freq = int(freq)
        return char, freq

# check if there are still any unknown letters in the word:
def check_win(word):
    if word.count("-") == 0:
        return True
    else:
        return False

# if letter is correct, ask for and set the position of the letter in word
def user_prompt():
    global f
    global word
    # ask for the 1st letter hint
    while not (f == []):
        print ("\nAny letter prompts? Type your word with letter(s) and '-' in it and hit Enter:")
        inp = input()
        if int(len(inp)) == wl:
            word = inp
            inp = inp.replace("-", ".")
            r = re.compile(inp)
            f = list(filter(r.match, f))
            break
        else:
            print("Sorry, this doesn't match your word length. Please try again:\n")
            continue
    else:
        print("Sorry, such word doesn't exist in our dictionary. I give up.")


# computer tries to guess the letter:
def try_to_guess():
    global attempts
    global word
    global f
# find most used character from filtered list:
    char, freq = cnt_char(f)
    fl = filter_length(f)
    print("\nMy next guess is '{}'.".format(char),"Its probability is {0:.0%}.".format(freq/fl))
    attempts += 1
    inp = input("Is it in your word? Type the word with this letter(s) in OR type 'N' for 'no'\n").lower()
    if inp == "n":
# filter out words with this letter from the list
        f = list(filter(lambda w: all([letter != char for letter in w]), f))
    else:
        while not (f==[]):
            if int(len(inp)) == wl:
                word = inp
                inpt = inp.replace("-", ".")
                r = re.compile(inpt)
                f = list(filter(r.match, f))
                break
            else:
                print("Sorry, this doesn't match your word length. Please try again:\n")
                break
            continue
        else:
            print("Sorry, such word doesn't exist in our disctionary. I give up")


# actual game
def play_game():
    user_prompt()
    while not (check_win(word) or f == []):
        try_to_guess()
    else:
        if f == []:
           print("Sorry, such word doesn't exist in our dictionary. I give up.")
        elif check_win(word):
            print("\nI did it! I'm a very smart computer! It took me {} attempts".format(attempts))


play_game()
